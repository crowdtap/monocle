general:
  branches:
    ignore:
      - production
machine:
  timezone:
    America/New_York
  services:
    - docker
  environment:
    RAILS_ENV: test
    PATH: $PATH:node_modules/.bin
    EXTERNAL_REGISTRY_BASE_DOMAIN: 535700620794.dkr.ecr.us-east-1.amazonaws.com
    REPOSITORY_NAME: monocle
    REGISTRY_EMAIL: none
    REGISTRY_USERNAME: AWS
    AWS_DEFAULT_REGION: us-east-1

    CI_SHA1: $CIRCLE_SHA1
    CI_BRANCH: $CIRCLE_BRANCH
    CI_BUILD_NUM: $CIRCLE_BUILD_NUM

    DOCKERTAG: monocle
    SERVICENAME: monocle

    CLUSTER_NICKNAME_PRODUCTION:  production-1.working.crowdtap.com
    CLUSTER_NICKNAME_WORKING: working-1.working.crowdtap.com

dependencies:
  pre:
    - gem install bundler
    - npm install
    - docker-pull
    - bundle install --path .localgems
    - docker build --rm=false -t ${DOCKERTAG}:latest .

deployment:
  staging:
    branch: kubernetes
    commands:
      - docker-push -f deploy/staging.config
      - ensure-kubectl
      - prepare-kubectl
      - kubectl config set-context staging --user $CLUSTER_NICKNAME_WORKING --cluster $CLUSTER_NICKNAME_WORKING --namespace staging
      - kubectl config use-context staging
      - k8s-deploy -f deploy/staging.config
